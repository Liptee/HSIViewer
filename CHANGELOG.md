# Changelog

Все значимые изменения в проекте HSIView будут документированы в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект придерживается [Semantic Versioning](https://semver.org/lang/ru/).

## [Unreleased]

### Добавлено

- **Оптимизация памяти**: хранение данных в оригинальных типах
  - `DataStorage` enum для хранения float32/64, int8/16/32, uint8/16
  - uint8: экономия **88%** памяти (16.8 ГБ для файла 2.4 ГБ)
  - uint16/float32: экономия **50-75%** памяти
  - Конвертация в Double только при рендеринге
  - Полная обратная совместимость API

### Исправлено

- **Критическое исправление NPY order (v2)**: автоматическая поддержка C/Fortran order
  - Добавлен флаг `isFortranOrder` в `HyperCube`
  - Правильная индексация как в NumPy (без переупорядочивания данных!)
  - C-order: `i2 + d2*(i1 + d1*i0)`, Fortran-order: `i0 + d0*(i1 + d1*i2)`
  - **Удалена** функция переупорядочивания (экономия ~20 ГБ памяти!)
  - Работает для любых NPY файлов (C-order и Fortran-order)
  
- **Критическое исправление NPY**: крэш при загрузке больших файлов (>2 ГБ)
  - Исправлена индексация `Data.SubSequence` → `Data`
  - Оптимизировано чтение: один `withUnsafeBytes` вместо N вызовов
  - Производительность улучшена в ~2500x для больших файлов
  - Протестировано на `uint8 (7958, 1280, 250)` = 2.5 ГБ

## [0.2.3] - 2025-11-28

### Добавлено

- **Интеграция с Finder для .npy файлов**: можно открывать двойным кликом
  - Регистрация UTI для .npy
  - Настройка CFBundleDocumentTypes
  - HSIView как приложение по умолчанию для .npy
- **Поддержка NumPy .npy формата**: полная реализация загрузчика
  - Поддержка float32/64, int8/16/32/64, uint8/16/32
  - Обработка C-order и Fortran-order
  - Версии 1.0, 2.0, 3.0
  - 2D и 3D массивы
- **Иконка приложения**: настроена для отображения в Dock, Finder и окне приложения
- **Поддержка 2D изображений**: автоматическое определение и отображение
  - Обработка данных с размерностью вида `(H, W, 1)`, `(1, H, W)`, `(C, H, 1)`
  - Упрощенный UI для 2D (скрываются ненужные контролы)
  - Специальный рендеринг для 2D случая
- Информационная панель справа с характеристиками изображения:
  - Формат источника (MATLAB, TIFF)
  - Тип данных (Float64, Float32, UInt8 и т.д.)
  - Разрешение (размеры куба)
  - Количество каналов
  - Статистика (min, max, среднее, станд. отклонение)
  - Размер в памяти
- Enum `DataType` для отслеживания оригинального типа данных
- Метаданные `sourceFormat` в `HyperCube`
- Возможность сворачивания/разворачивания информационной панели

### Изменено

- Увеличена минимальная ширина окна с 700 до 960 пикселей (для панели)
- `HyperCube` теперь хранит информацию об оригинальном типе данных
- UI адаптируется к размерности данных (2D/3D)
- Улучшено приветственное сообщение (упоминание 2D и 3D)

### Исправлено

- **Критическое исправление рендеринга TIFF**: вертикальные полосы и искаженное изображение
  - Изменен порядок dims: (C,H,W) → (H,W,C) для HWC layout
  - Исправлена индексация column-major: `row + H*(col + W*channel)`
  - Default layout для TIFF: CHW → HWC
  - Упрощен код (убран промежуточный буфер)
- **Исправление загрузки NumPy**: удалена некорректная конвертация Fortran-order
  - NumPy Fortran-order уже использует column-major (как MATLAB)
  - Данные используются напрямую без транспонирования
- **Crash при загрузке 2D данных** (например, `(5270, 5720, 1)`)
- Ошибка в определении количества каналов для 2D
- Проблема с слайдером каналов для 2D данных

## [0.2.0] - 2025-11-27

### Добавлено

- Модульная архитектура с четким разделением ответственности
- Протокол `ImageLoader` для расширяемой поддержки форматов
- `ImageLoaderFactory` для автоматического определения формата
- Класс `DataNormalizer` с 3 методами нормализации (Min-Max, Z-Score, Percentile)
- Класс `ImageRenderer` для централизованного рендеринга
- Класс `WavelengthManager` для работы с длинами волн
- Extension `HyperCube+Statistics` для вычисления статистики и спектров пикселей
- Enum `ImageLoadError` для типизированной обработки ошибок
- Использование `Result<T, Error>` вместо опционалов
- Документация:
  - `README.md` - главная документация
  - `ARCHITECTURE.md` - описание архитектуры
  - `DEVELOPER_GUIDE.md` - руководство разработчика
  - `REFACTORING_SUMMARY.md` - резюме рефакторинга
  - `PROJECT_STRUCTURE.md` - структура проекта
  - `CHANGELOG.md` - этот файл
- Пример загрузчика `NpyImageLoader.swift.example` для будущего расширения

### Изменено

- Разделен монолитный `HyperCube.swift` (377 строк) на модули:
  - `Models/HyperCubeModel.swift` (72 строки)
  - `Utilities/ImageRenderer.swift` (180 строк)
  - `Services/MatImageLoader.swift` (45 строк)
  - `Services/TiffImageLoader.swift` (45 строк)
  - `Utilities/DataNormalization.swift` (85 строк)
- Рефакторинг `AppState.swift` для использования новой архитектуры
- Рефакторинг `ContentView.swift` для использования `ImageRenderer`
- Улучшена обработка ошибок с подробными сообщениями
- Оптимизирован рендеринг изображений (устранено дублирование)
- Текст кнопки "Открыть .mat…" → "Открыть файл…" (универсальность)
- Упрощен `Header.h` (убрано дублирование)

### Удалено

- `ViewController.swift` (не использовался)
- Дублированный код нормализации (было в 3 местах)
- Дублированный код определения осей (было в 2 местах)

### Исправлено

- Потенциальные утечки памяти в C-интеропе (добавлены `defer`)
- Проблемы с обработкой ошибок (замена nil на Result)
- Связанность модулей (высокая → низкая)

### Безопасность

- Улучшена валидация данных при загрузке
- Добавлены проверки размерностей
- Безопасная работа с C-указателями через `defer`

## [0.1.0] - 2025-11-26

### Добавлено

- Первый рабочий прототип
- Поддержка загрузки `.mat` файлов (через libmatio)
- Поддержка загрузки `.tiff` файлов (через libtiff)
- Поканальный просмотр в grayscale режиме
- Простой RGB синтез по длинам волн
- Слайдер для переключения каналов
- Выбор layout'а (Auto, CHW, HWC)
- Загрузка длин волн из `.txt` файла
- Генерация равномерного диапазона длин волн
- Открытие файлов из Finder
- Автоматическое вписывание изображения в окно
- Базовый UI с SwiftUI
- C-обертки для libmatio и libtiff

### Технические детали

- SwiftUI для UI
- Combine для reactive state
- C interop для работы с библиотеками
- Column-major порядок для MATLAB совместимости

---

## Типы изменений

- `Добавлено` - новая функциональность
- `Изменено` - изменения в существующей функциональности
- `Устарело` - функциональность, которая скоро будет удалена
- `Удалено` - удаленная функциональность
- `Исправлено` - исправления багов
- `Безопасность` - исправления уязвимостей

## Планируется

### [0.3.0] - TBD

**Новые форматы**
- [ ] Поддержка `.npy` (NumPy)
- [ ] Поддержка `.hdr/.img` (ENVI)
- [ ] Поддержка `.h5` (HDF5)

**Визуализация**
- [ ] График спектра пикселя
- [ ] Histogram view
- [ ] False color композиты
- [ ] PCA визуализация (первые 3 компоненты)

**UI/UX**
- [ ] Zoom и Pan
- [ ] Keyboard shortcuts
- [ ] Прогресс-бар при загрузке
- [ ] Thumbnail preview
- [ ] Множественные окна/табы

**Экспорт**
- [ ] Экспорт в PNG/JPEG
- [ ] Экспорт в другие форматы (конвертер)
- [ ] Batch export

**Обработка**
- [ ] Различные методы нормализации в UI
- [ ] Конвертация типов данных
- [ ] Histogram equalization
- [ ] Spatial filtering

**Производительность**
- [ ] Lazy loading для больших файлов
- [ ] Кэширование rendered images
- [ ] Многопоточная обработка
- [ ] GPU ускорение (Metal)

**Тестирование**
- [ ] Unit tests
- [ ] Integration tests
- [ ] UI tests
- [ ] Performance tests

**Документация**
- [ ] CONTRIBUTING.md
- [ ] LICENSE
- [ ] In-app help
- [ ] Video tutorials

---

[0.2.0]: https://github.com/yourrepo/HSIView/compare/v0.1.0...v0.2.0
[0.1.0]: https://github.com/yourrepo/HSIView/releases/tag/v0.1.0

