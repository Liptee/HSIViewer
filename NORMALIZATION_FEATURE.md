# Функция нормализации гиперкубов

## Описание

Добавлена полная система нормализации гиперспектральных данных с 7 типами нормализаций и настраиваемыми параметрами.

## Расположение

**Правая панель → "Нормализация"** (под панелью "Информация об изображении")

## Типы нормализаций

### 1. Без нормализации
**Описание:** Исходные данные без преобразований  
**Параметры:** Нет  
**Формула:** `x' = x`

### 2. Min-Max (0-1)
**Описание:** Линейная нормализация в диапазон [0, 1]  
**Параметры:** Нет  
**Формула:**
```
x' = (x - min) / (max - min)
```

### 3. Min-Max (custom)
**Описание:** Линейная нормализация в заданный диапазон  
**Параметры:**
- `Min`: целевое минимальное значение (по умолчанию: 0.0)
- `Max`: целевое максимальное значение (по умолчанию: 1.0)

**Формула:**
```
normalized = (x - data_min) / (data_max - data_min)
x' = target_min + normalized * (target_max - target_min)
```

**Примеры использования:**
- `[0, 255]` - для преобразования в uint8
- `[-1, 1]` - для нейронных сетей
- `[0, 100]` - для процентных значений

### 4. Percentile
**Описание:** Обрезка выбросов по процентилям  
**Параметры:**
- `Нижний %`: нижний процентиль (по умолчанию: 2.0)
- `Верхний %`: верхний процентиль (по умолчанию: 98.0)

**Формула:**
```
p_lower = percentile(data, lower_pct)
p_upper = percentile(data, upper_pct)
x_clamped = clamp(x, p_lower, p_upper)
x' = (x_clamped - p_lower) / (p_upper - p_lower)
```

**Применение:**  
Убирает выбросы и улучшает контрастность основной части данных.

### 5. Z-Score
**Описание:** Стандартизация с нулевым средним и единичной дисперсией  
**Параметры:** Нет  
**Формула:**
```
x' = (x - mean) / std_dev
```

**Применение:**  
Используется в машинном обучении для нормализации признаков.

### 6. Log
**Описание:** Логарифмическое преобразование  
**Параметры:** Нет  
**Формула:**
```
x' = log(max(0, x) + 1)
```

**Применение:**  
Сжимает большие значения, растягивает малые. Полезно для данных с экспоненциальным распределением.

### 7. Sqrt
**Описание:** Квадратный корень  
**Параметры:** Нет  
**Формула:**
```
x' = sqrt(max(0, x))
```

**Применение:**  
Уменьшает влияние выбросов, сохраняя распределение.

## Реализация

### Компоненты:

**HSIView/Models/CubeNormalization.swift:**
- `CubeNormalizationType` - enum с типами нормализаций
- `CubeNormalizationParameters` - структура с параметрами
- `CubeNormalizer` - класс с методами применения нормализаций

**HSIView/Views/NormalizationPanel.swift:**
- UI панель с выбором типа нормализации
- Динамические поля для параметров
- Кнопка "Применить"

**HSIView/AppState.swift:**
- `@Published var normalizationType` - текущий тип
- `@Published var normalizationParams` - текущие параметры
- `originalCube` - оригинальные данные
- `cube` - нормализованная версия
- `applyNormalization()` - применение нормализации

**HSIView/ContentView.swift:**
- Интеграция `NormalizationPanel` в правую панель

## Использование

### Базовое применение:

1. Откройте гиперспектральный файл
2. В правой панели найдите раздел "Нормализация"
3. Выберите тип нормализации из выпадающего списка
4. Если нужно, настройте параметры
5. Нажмите "Применить"

### Примеры сценариев:

**Сценарий 1: Улучшение контрастности**
```
Тип: Percentile
Нижний %: 2.0
Верхний %: 98.0
→ Применить
```
Результат: Обрезаны 2% самых темных и самых светлых пикселей, остальные растянуты на весь диапазон.

**Сценарий 2: Подготовка для нейросети**
```
Тип: Min-Max (custom)
Min: -1.0
Max: 1.0
→ Применить
```
Результат: Данные нормализованы в диапазон [-1, 1], типичный для PyTorch.

**Сценарий 3: Работа с экспоненциальными данными**
```
Тип: Log
→ Применить
```
Результат: Логарифмическое сжатие больших значений.

**Сценарий 4: Возврат к оригиналу**
```
Тип: Без нормализации
→ Применить
```
Результат: Восстановлены оригинальные данные.

## Технические детали

### Хранение данных:

- `originalCube` - всегда хранит оригинальные данные
- `cube` - содержит текущую (возможно нормализованную) версию
- При изменении файла обе переменные сбрасываются

### Формат нормализованных данных:

- Всегда сохраняются как `DataStorage.float64([Double])`
- Оригинальный тип данных не сохраняется
- `sourceFormat` обновляется с суффиксом (например: "MATLAB (.mat) [MinMax]")

### Производительность:

**Для больших кубов:**
- Min-Max: O(n) - один проход
- Z-Score: O(n) - один проход
- Percentile: O(n log n) - требует сортировки
- Log, Sqrt: O(n) - один проход

**Память:**
- Создается полная копия данных в float64
- Для куба 1000×1000×100: ~800 МБ дополнительно

**Рекомендации:**
- Для больших кубов (>2 ГБ) используйте Min-Max или Z-Score
- Percentile может быть медленным на кубах >10 млн элементов

## Формулы в деталях

### Min-Max с параметрами:

```swift
let stats = cube.statistics()
let data_min = stats.min
let data_max = stats.max
let range = data_max - data_min
let target_range = target_max - target_min

for value in data {
    normalized = (value - data_min) / range
    result = target_min + normalized * target_range
}
```

### Percentile с обрезкой:

```swift
// Сортируем все значения
sorted = sort(all_values)

// Находим граничные значения
p_lower = sorted[int(count * lower_pct / 100)]
p_upper = sorted[int(count * upper_pct / 100)]

// Обрезаем и нормализуем
for value in data {
    clamped = clamp(value, p_lower, p_upper)
    result = (clamped - p_lower) / (p_upper - p_lower)
}
```

## Ограничения

**Текущие ограничения:**
1. Нормализация применяется ко всему кубу целиком
2. Нельзя нормализовать отдельные каналы
3. Нельзя применить разные нормализации к разным областям
4. История нормализаций не сохраняется

**Возможные улучшения:**
- Поканальная нормализация
- Нормализация по регионам (ROI)
- История преобразований с возможностью отката
- Предпросмотр до применения
- Сохранение нормализованного куба в файл

## Примеры результатов

### До и После (Percentile 2-98):

```
До:
  Min: -9999.0 (no-data значения)
  Max: 4.85
  Mean: -806.38

После:
  Min: 0.0
  Max: 1.0
  Mean: 0.42
  (выбросы обрезаны, данные растянуты)
```

### До и После (Z-Score):

```
До:
  Min: 0.0
  Max: 255.0
  Mean: 127.5
  StdDev: 73.5

После:
  Min: -1.73
  Max: 1.73
  Mean: 0.0
  StdDev: 1.0
```

## Дата

2025-11-28


