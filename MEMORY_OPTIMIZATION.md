# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏

## –ü—Ä–æ–±–ª–µ–º–∞

–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ **–≤—Å–µ –¥–∞–Ω–Ω—ã–µ** –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ `Double` (8 –±–∞–π—Ç), —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ–≥—Ä–æ–º–Ω–æ–º—É —Ä–∞—Å—Ö–æ–¥—É –ø–∞–º—è—Ç–∏:

| –¢–∏–ø –Ω–∞ –¥–∏—Å–∫–µ | –†–∞–∑–º–µ—Ä | Double | –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç |
|-------------|--------|--------|-------------|
| uint8 | 1 –±–∞–π—Ç | 8 –±–∞–π—Ç | **8x** üò± |
| uint16 | 2 –±–∞–π—Ç | 8 –±–∞–π—Ç | **4x** |
| int16 | 2 –±–∞–π—Ç | 8 –±–∞–π—Ç | **4x** |
| float32 | 4 –±–∞–π—Ç | 8 –±–∞–π—Ç | **2x** |
| int32 | 4 –±–∞–π—Ç | 8 –±–∞–π—Ç | **2x** |
| float64 | 8 –±–∞–π—Ç | 8 –±–∞–π—Ç | 1x |

**–ü—Ä–∏–º–µ—Ä:**  
–§–∞–π–ª `uint8 (7958, 1280, 250)` = 2.4 –ì–ë ‚Üí **19.2 –ì–ë –≤ –ø–∞–º—è—Ç–∏!**

## –†–µ—à–µ–Ω–∏–µ

–•—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –≤ **–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ç–∏–ø–µ** –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ `Double` —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ.

### 1. –ù–æ–≤—ã–π enum DataStorage

```swift
enum DataStorage {
    case float64([Double])
    case float32([Float])
    case int8([Int8])
    case int16([Int16])
    case int32([Int32])
    case uint8([UInt8])
    case uint16([UInt16])
    
    func getValue(at index: Int) -> Double {
        switch self {
        case .float64(let arr): return arr[index]
        case .float32(let arr): return Double(arr[index])
        case .int8(let arr): return Double(arr[index])
        // ... –∏ —Ç.–¥.
        }
    }
}
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω HyperCube

```swift
struct HyperCube {
    let dims: (Int, Int, Int)
    let storage: DataStorage  // ‚Üê –í–º–µ—Å—Ç–æ let data: [Double]
    let sourceFormat: String
    let isFortranOrder: Bool
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    func getValue(at linearIndex: Int) -> Double {
        return storage.getValue(at: linearIndex)
    }
}
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –∑–∞–≥—Ä—É–∑—á–∏–∫–∏

**NPY Loader:**
```swift
// –ë—ã–ª–æ: –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ Double
var values: [Double] = []
for i in 0..<totalElements {
    values.append(Double(buffer[i]))
}

// –°—Ç–∞–ª–æ: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ç–∏–ø–µ
var values = [UInt8]()
for i in 0..<totalElements {
    values.append(buffer[i])
}
return .uint8(values)  // DataStorage
```

**MAT Loader:**
```swift
let storage: DataStorage = .float64(arr)  // MATLAB –æ–±—ã—á–Ω–æ float64
```

**TIFF Loader:**
```swift
let uint8Arr = arr.map { UInt8(clamping: Int($0)) }
let storage: DataStorage = .uint8(uint8Arr)
```

### 4. –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ä–µ–Ω–¥–µ—Ä–µ—Ä—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

–í—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ `cube.data[index]` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `cube.getValue(at: index)`:

```swift
// –ë—ã–ª–æ:
slice[y * w + x] = cube.data[lin]

// –°—Ç–∞–ª–æ:
slice[y * w + x] = cube.getValue(at: lin)
```

–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ `Double` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞.

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏

| –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö | –§–∞–π–ª 2.4 –ì–ë | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –≠–∫–æ–Ω–æ–º–∏—è |
|-----------|-------------|----------------|-------------------|----------|
| **uint8** | 2.4 –ì–ë | 19.2 –ì–ë | **2.4 –ì–ë** | **-16.8 –ì–ë (88%)** ‚ú® |
| **uint16** | 4.8 –ì–ë | 19.2 –ì–ë | **4.8 –ì–ë** | **-14.4 –ì–ë (75%)** ‚ú® |
| **float32** | 9.6 –ì–ë | 19.2 –ì–ë | **9.6 –ì–ë** | **-9.6 –ì–ë (50%)** ‚ú® |
| **float64** | 19.2 –ì–ë | 19.2 –ì–ë | **19.2 –ì–ë** | 0 –ì–ë (0%) |

### –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –º–æ–Ω–∏–ª–∏–æ–∑_1.npy (uint8, 2.4 –ì–ë):

```
–î–æ:  ~19.2 –ì–ë –≤ –ø–∞–º—è—Ç–∏
–ü–æ—Å–ª–µ: ~2.4 –ì–ë –≤ –ø–∞–º—è—Ç–∏
–≠–∫–æ–Ω–æ–º–∏—è: 16.8 –ì–ë (88%)! üéâ
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ó–∞–≥—Ä—É–∑–∫–∞

- ‚úÖ **–ë—ã—Å—Ç—Ä–µ–µ:** –Ω–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ uint8‚ÜíDouble –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- ‚úÖ **–ú–µ–Ω—å—à–µ –∞–ª–ª–æ–∫–∞—Ü–∏–π:** –æ–¥–∏–Ω –º–∞—Å—Å–∏–≤ –≤–º–µ—Å—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö

### –†–µ–Ω–¥–µ—Ä–∏–Ω–≥

- ‚ö†Ô∏è **–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ:** –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π
- ‚úÖ **–ö–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç—Å—è:** –ª—É—á—à–∞—è –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫—ç—à–∞ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç–∏–ø–æ–≤ (uint8)

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- ‚ö†Ô∏è **–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ:** –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è—Ö
- ‚úÖ **–ü—Ä–∏–µ–º–ª–µ–º–æ:** –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑, –∫—ç—à–∏—Ä—É–µ—Ç—Å—è

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ **–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
- –í—Å–µ API –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏
- `getValue()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Double` –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- –†–µ–Ω–¥–µ—Ä–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö —Ç–∏–ø–æ–≤ (uint32, uint64, int64)

–î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏ –±–æ–ª—å—à–∏–µ —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã **—Å–∂–∏–º–∞—é—Ç—Å—è**:

```swift
// uint32, uint64 ‚Üí uint16
let values = [UInt16]()
for i in 0..<totalElements {
    values.append(UInt16(clamping: buffer[i]))
}
return .uint16(values)

// int64 ‚Üí int32
let values = [Int32]()
for i in 0..<totalElements {
    values.append(Int32(clamping: buffer[i]))
}
return .int32(values)
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–ª—è –≥–∏–ø–µ—Ä—Å–ø–µ–∫—Ç—Ä–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —ç—Ç–æ –æ–±—ã—á–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏—è –ø–∏–∫—Å–µ–ª–µ–π –æ–±—ã—á–Ω–æ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0-65535.

### DataStorage –º–µ—Ç–æ–¥—ã

```swift
// –ü–æ–ª—É—á–∏—Ç—å –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç
func getValue(at index: Int) -> Double

// –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
var count: Int

// –ü–æ–ª—É—á–∏—Ç—å —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö
var dataType: DataType

// –ü–æ–ª—É—á–∏—Ç—å —Å—Ä–µ–∑ (–¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
func getSlice(indices: [Int]) -> [Double]
```

## –ú–∏–≥—Ä–∞—Ü–∏—è

### –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞

**–ë—ã–ª–æ:**
```swift
let value = cube.data[linearIndex]
```

**–°—Ç–∞–ª–æ:**
```swift
let value = cube.getValue(at: linearIndex)
// –∏–ª–∏
let value = cube.getValue(i0: i0, i1: i1, i2: i2)
```

### –î–ª—è –Ω–æ–≤—ã—Ö –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–≤

```swift
// 1. –ß–∏—Ç–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ç–∏–ø–µ
var values = [UInt8]()
// ... —á—Ç–µ–Ω–∏–µ ...

// 2. –û–±–µ—Ä–Ω–∏—Ç–µ –≤ DataStorage
let storage: DataStorage = .uint8(values)

// 3. –°–æ–∑–¥–∞–π—Ç–µ HyperCube
return .success(HyperCube(
    dims: dims,
    storage: storage,  // ‚Üê –≤–º–µ—Å—Ç–æ data
    sourceFormat: "...",
    isFortranOrder: ...
))
```

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **SIMD –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏** –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤
2. **Lazy evaluation** –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
3. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** –¥–ª—è –±–æ–ª—å—à–∏—Ö –º–∞—Å—Å–∏–≤–æ–≤
4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å—Ä–µ–∑–æ–≤

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- `HSIView/Models/HyperCubeModel.swift`:
  - –î–æ–±–∞–≤–ª–µ–Ω `enum DataStorage`
  - `HyperCube.storage` –≤–º–µ—Å—Ç–æ `HyperCube.data`
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã `getValue()`
  
- `HSIView/Services/NpyImageLoader.swift`:
  - `parseNpyData()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `DataStorage`
  - –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ç–∏–ø–µ
  
- `HSIView/Services/MatImageLoader.swift`:
  - –û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ `DataStorage.float64`
  
- `HSIView/Services/TiffImageLoader.swift`:
  - –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ `UInt8` –∏ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤ `DataStorage.uint8`
  
- `HSIView/Utilities/ImageRenderer.swift`:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `cube.getValue()` –≤–º–µ—Å—Ç–æ `cube.data[]`
  
- `HSIView/Extensions/HyperCube+Statistics.swift`:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `storage.getValue()` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

## –î–∞—Ç–∞

2025-11-28

## –ò—Ç–æ–≥

‚úÖ **–û–≥—Ä–æ–º–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏:** –¥–æ 88% –¥–ª—è uint8!  
‚úÖ **–ë–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:** –ø–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å  
‚úÖ **–ù–µ–±–æ–ª—å—à–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:** –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç—Å—è —ç–∫–æ–Ω–æ–º–∏–µ–π –ø–∞–º—è—Ç–∏  
‚úÖ **–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–∞–π–ª–∞–º–∏ >10 –ì–ë –Ω–∞ –º–∞—à–∏–Ω–∞—Ö —Å 16 –ì–ë RAM!**

