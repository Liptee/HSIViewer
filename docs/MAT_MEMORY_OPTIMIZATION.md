# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è MAT —Ñ–∞–π–ª–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞

MAT —Ñ–∞–π–ª—ã —Å uint8 –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–Ω–∏–º–∞–ª–∏ **8x –ø–∞–º—è—Ç–∏** –∏–∑-–∑–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ `double`.

**–ü—Ä–∏–º–µ—Ä:**
```
–§–∞–π–ª asphalt2.mat: 100 –ú–ë (uint8)
–í –ø–∞–º—è—Ç–∏: 800 –ú–ë (double) ‚Üê 8x overhead!
```

## –†–µ—à–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Ö—Ä–∞–Ω–µ–Ω–∏–µ MAT –¥–∞–Ω–Ω—ã—Ö –≤ **–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–∞—Ö** (–∫–∞–∫ –¥–ª—è NPY –∏ TIFF).

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

```c
// MatHelper.c - —Å—Ç–∞—Ä—ã–π –∫–æ–¥
double *buf = malloc(total * sizeof(double));

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è uint8 ‚Üí double
uint8_t *src = (uint8_t *)full->data;
for (i = 0; i < total; ++i) {
    buf[i] = (double)src[i];  // uint8 ‚Üí double (1 –±–∞–π—Ç ‚Üí 8 –±–∞–π—Ç)
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** uint8 100 –ú–ë ‚Üí double 800 –ú–ë

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

```c
// MatHelper.c - –Ω–æ–≤—ã–π –∫–æ–¥
void *buf = malloc(total * sizeof(uint8_t));  // ‚Üê –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–∏–ø!

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
memcpy(buf, full->data, total * sizeof(uint8_t));
outCube->data_type = MAT_DATA_UINT8;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** uint8 100 –ú–ë ‚Üí uint8 100 –ú–ë ‚úÖ

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. MatHelper.h - –Ω–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**–ë—ã–ª–æ:**
```c
typedef struct {
    double *data;    // –í—Å–µ–≥–¥–∞ double
    size_t dims[3];
    int rank;
} MatCube3D;
```

**–°—Ç–∞–ª–æ:**
```c
typedef enum {
    MAT_DATA_FLOAT64 = 0,
    MAT_DATA_FLOAT32 = 1,
    MAT_DATA_UINT8 = 2,
    MAT_DATA_UINT16 = 3,
    MAT_DATA_INT8 = 4,
    MAT_DATA_INT16 = 5
} MatDataType;

typedef struct {
    void *data;              // ‚Üê –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–∏–ø!
    size_t dims[3];
    int rank;
    MatDataType data_type;   // ‚Üê –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–ø–µ
} MatCube3D;
```

### 2. MatHelper.c - –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

**–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞:**
```c
if (full->class_type == MAT_C_UINT8 && full->data_type == MAT_T_UINT8) {
    buf = malloc(total * sizeof(uint8_t));  // ‚Üê –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
    memcpy(buf, full->data, total * sizeof(uint8_t));  // ‚Üê –ë–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
    dataType = MAT_DATA_UINT8;
}

// –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è uint16, int8, int16, float32, float64
```

### 3. MatImageLoader.swift - —Å–æ–∑–¥–∞–Ω–∏–µ DataStorage

**–ë—ã–ª–æ:**
```swift
let buffer = UnsafeBufferPointer(start: ptr, count: count)
let arr = Array(buffer)
let storage: DataStorage = .float64(arr)  // –í—Å–µ–≥–¥–∞ float64
```

**–°—Ç–∞–ª–æ:**
```swift
switch cCube.data_type {
case MAT_DATA_UINT8:
    let typedPtr = ptr.bindMemory(to: UInt8.self, capacity: count)
    let buffer = UnsafeBufferPointer(start: typedPtr, count: count)
    storage = .uint8(Array(buffer))  // ‚Üê –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–∏–ø!
    
case MAT_DATA_FLOAT64:
    let typedPtr = ptr.bindMemory(to: Double.self, capacity: count)
    let buffer = UnsafeBufferPointer(start: typedPtr, count: count)
    storage = .float64(Array(buffer))
    
// –ò —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤
}
```

## –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏

| –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö | –†–∞–∑–º–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞ | –§–∞–π–ª 100 –ú–ë: –î–æ | –§–∞–π–ª 100 –ú–ë: –ü–æ—Å–ª–µ | –≠–∫–æ–Ω–æ–º–∏—è |
|------------|-----------------|-----------------|---------------------|----------|
| **uint8** | 1 –±–∞–π—Ç | 800 –ú–ë | **100 –ú–ë** | **-700 –ú–ë (88%)** üéâ |
| **uint16** | 2 –±–∞–π—Ç–∞ | 800 –ú–ë | **200 –ú–ë** | **-600 –ú–ë (75%)** üéâ |
| **int16** | 2 –±–∞–π—Ç–∞ | 800 –ú–ë | **200 –ú–ë** | **-600 –ú–ë (75%)** üéâ |
| **float32** | 4 –±–∞–π—Ç–∞ | 800 –ú–ë | **400 –ú–ë** | **-400 –ú–ë (50%)** üéâ |
| **float64** | 8 –±–∞–π—Ç | 800 –ú–ë | 800 –ú–ë | 0 (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) |

### –ü—Ä–∏–º–µ—Ä –¥–ª—è asphalt2.mat:

**–î–æ:**
```
–§–∞–π–ª: 1920√ó1080√ó250 √ó uint8 = 518.4 –ú–ë
–í –ø–∞–º—è—Ç–∏: 518.4 –ú–ë √ó 8 = 4147.2 –ú–ë (~4 –ì–ë)
```

**–ü–æ—Å–ª–µ:**
```
–§–∞–π–ª: 1920√ó1080√ó250 √ó uint8 = 518.4 –ú–ë
–í –ø–∞–º—è—Ç–∏: 518.4 –ú–ë √ó 1 = 518.4 –ú–ë
–≠–ö–û–ù–û–ú–ò–Ø: 3628.8 –ú–ë (88%)! üéâ
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥

**–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º:**
```swift
// ImageRenderer.swift
let value = cube.getValue(at: lin)  // ‚Üê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ Double

// DataStorage.getValue()
func getValue(at index: Int) -> Double {
    switch self {
    case .uint8(let arr):
        return Double(arr[index])  // uint8 ‚Üí Double –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
    case .float64(let arr):
        return arr[index]
    // ...
    }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
1. ‚úÖ –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ç–∏–ø–µ (—ç–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏)
2. ‚úÖ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–æ–ª—É—á–∞–µ—Ç Double (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ)
3. ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ (–Ω–µ –¥–ª—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö)

## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å

**–†–∞–∑–º–µ—Ä –≤ –ø–∞–º—è—Ç–∏ —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π:**
```swift
// ImageInfoPanel.swift
infoRow(title: "–†–∞–∑–º–µ—Ä –≤ –ø–∞–º—è—Ç–∏", value: formatMemorySize(bytes: cube.storage.sizeInBytes))

// DataStorage.sizeInBytes
var sizeInBytes: Int {
    switch self {
    case .uint8(let arr):
        return arr.count * 1  // ‚Üê –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä!
    case .float64(let arr):
        return arr.count * 8
    // ...
    }
}
```

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã

| –§–æ—Ä–º–∞—Ç | –¢–∏–ø—ã | –ü–∞–º—è—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ |
|--------|------|----------------------|
| **MAT** | float64, float32, uint8, uint16, int8, int16 | ‚úÖ –í–°–ï |
| **NPY** | float64, float32, uint8, uint16, int8, int16, int32 | ‚úÖ –í–°–ï |
| **TIFF** | uint8 | ‚úÖ |

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
```bash
cd /Users/mac/Desktop/HSIView
open HSIView.xcodeproj
# Cmd+R
```

### 2. –û—Ç–∫—Ä–æ–π—Ç–µ asphalt2.mat (uint8):

**–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ –§–∞–π–ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
  - –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: UInt8
  - –†–∞–∑–º–µ—Ä –≤ –ø–∞–º—è—Ç–∏: ~518 –ú–ë (–≤–º–µ—Å—Ç–æ 4 –ì–ë!)
  - –î–∏–∞–ø–∞–∑–æ–Ω: 0-255

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Activity Monitor:

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```
HSIView: 4.5 –ì–ë –ø–∞–º—è—Ç–∏
```

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```
HSIView: 600-700 –ú–ë –ø–∞–º—è—Ç–∏
–≠–ö–û–ù–û–ú–ò–Ø: ~3.8 –ì–ë! üéâ
```

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

**–í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã —Ç–µ–ø–µ—Ä—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:**

| –§–∞–π–ª | –¢–∏–ø | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –≠–∫–æ–Ω–æ–º–∏—è |
|------|-----|------|-------|----------|
| asphalt2.mat | uint8 | 4 –ì–ë | 518 –ú–ë | 88% üéâ |
| –º–æ–Ω–∏–ª–∏–æ–∑_1.npy | uint8 | 19.2 –ì–ë | 2.4 –ì–ë | 88% üéâ |
| Tablet.tiff | uint8 | 2.5 –ì–ë | 320 –ú–ë | 88% üéâ |
| scientific.mat | float64 | 800 –ú–ë | 800 –ú–ë | 0% (—É–∂–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ) |

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–ó–∞–≥—Ä—É–∑–∫–∞:**
- ‚úÖ **–ë—ã—Å—Ç—Ä–µ–µ**: –Ω–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ uint8 ‚Üí double
- ‚úÖ **–ú–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏**: –≤—ã–¥–µ–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–π –æ–±—ä–µ–º

**–†–µ–Ω–¥–µ—Ä–∏–Ω–≥:**
- –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π: –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ Double —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∫–∞–Ω–∞–ª–∞
- –î–ª—è –∫–∞–Ω–∞–ª–∞ 1920√ó1080: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 2 –ú–ë (–Ω–µ –≤–µ—Å—å –∫—É–±!)

## –î–∞—Ç–∞

2025-11-28


