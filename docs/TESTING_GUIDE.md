# Руководство по тестированию больших NPY файлов

## Создание тестовых файлов

Используйте скрипт `create_large_test_npy.py`:

```bash
python3 create_large_test_npy.py
```

Это создаст 4 тестовых файла:

1. **test_uint8_large.npy** - Большой uint8 куб (7958, 1280, 250) = 2.5 ГБ
2. **test_float64_medium.npy** - Средний float64 куб (512, 512, 31) = 64 МБ
3. **test_uint16_medium.npy** - Средний uint16 куб (1024, 1024, 50) = 100 МБ
4. **test_float32_small.npy** - Малый float32 куб (256, 256, 10) = 2.5 МБ

## Тестирование в приложении

### 1. Сборка приложения

```bash
open HSIView.xcodeproj
# Нажмите Cmd+R для запуска
```

### 2. Тестирование загрузки

**Тест 1: Большой файл (2.5 ГБ)**
- Откройте `test_uint8_large.npy`
- Ожидаемый результат: файл открывается без крэша
- Проверьте:
  - ✅ Информационная панель показывает: uint8, (7958, 1280, 250)
  - ✅ Изображение отображается корректно
  - ✅ Можно переключать каналы

**Тест 2: Производительность**
- Засеките время загрузки больших файлов
- Должно быть разумное время (< 10 секунд для 2.5 ГБ)

**Тест 3: Разные типы данных**
- Откройте все 4 тестовых файла по очереди
- Проверьте, что все типы данных определяются правильно

### 3. Проверка памяти

Откройте Activity Monitor (Мониторинг системы):
- Загрузите большой файл
- Проверьте потребление памяти
- Ожидаемо: ~2x размер файла (оригинал + Double массив)

## Отладка

Если возникают проблемы:

### 1. Проверьте заголовок NPY файла

```python
import numpy as np

data = np.load('test_uint8_large.npy')
print(f"Shape: {data.shape}")
print(f"Dtype: {data.dtype}")
print(f"Order: {'F' if data.flags['F_CONTIGUOUS'] else 'C'}")
```

### 2. Проверьте крэш-репорт

При крэше macOS создаст отчет:
```
~/Library/Logs/DiagnosticReports/HSIView-*.ips
```

Ищите строку с номером линии в NpyImageLoader.swift

### 3. Проверьте Xcode Console

При запуске из Xcode смотрите консоль на:
- Ошибки парсинга заголовка
- Несоответствие размеров данных
- Ошибки выделения памяти

## Известные ограничения

1. **Размер файла**: Теоретический максимум - размер доступной оперативной памяти
2. **Производительность**: Файлы >5 ГБ могут загружаться медленно
3. **Fortran order**: Поддерживается, но без дополнительного транспонирования

## Дополнительная информация

См. также:
- `NPY_LARGE_FILES_FIX.md` - детали исправления
- `NPY_SUPPORT.md` - общая информация о поддержке NPY
- `debug_npy.py` - скрипт для отладки NPY файлов

