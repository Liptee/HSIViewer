# ENVI: –î–æ—Å—Ç—É–ø –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

## üí° –ò–¥–µ—è

–í–º–µ—Å—Ç–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–∂–¥–æ–º—É –ø–∞—Ä–Ω–æ–º—É —Ñ–∞–π–ª—É –æ—Ç–¥–µ–ª—å–Ω–æ (.hdr –∏ .dat), –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ **–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏** –æ–¥–∏–Ω —Ä–∞–∑. –í—Å–µ —Ñ–∞–π–ª—ã –≤ –Ω–µ–π —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –ë—ã–ª–æ (–∑–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É):
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç pre_katrina05.hdr

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
1. ‚úÖ –î–æ—Å—Ç—É–ø –∫ .hdr –µ—Å—Ç—å
2. ‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ .dat
3. –î–∏–∞–ª–æ–≥: "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª pre_katrina05.dat"
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ñ–∞–π–ª
5. ‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω

–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø–æ–Ω—è—Ç–Ω–æ –∑–∞—á–µ–º –≤—ã–±–∏—Ä–∞—Ç—å —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä—è–¥–æ–º
```

### –°—Ç–∞–ª–æ (–∑–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏):
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç pre_katrina05.hdr

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
1. ‚úÖ –î–æ—Å—Ç—É–ø –∫ .hdr –µ—Å—Ç—å
2. ‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ .dat
3. –î–∏–∞–ª–æ–≥: "–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /test_data/"
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø"
5. ‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
6. ‚úÖ –û–±–∞ —Ñ–∞–π–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: –ü–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –≤—Å—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
```

## üîë –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –î–æ: –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ñ–∞–π–ª—É

```swift
private static func requestAccessToFile(_ fileURL: URL, description: String) -> URL? {
    guard !FileManager.default.isReadableFile(atPath: fileURL.path) else {
        return fileURL
    }
    
    let panel = NSOpenPanel()
    panel.message = "ENVI —Ñ–æ—Ä–º–∞—Ç —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–∞—Ä–Ω–æ–º—É —Ñ–∞–π–ª—É"
    panel.canChooseDirectories = false
    panel.canChooseFiles = true
    panel.nameFieldStringValue = fileURL.lastPathComponent  // –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª
    
    if panel.runModal() == .OK, let selectedURL = panel.url {
        return selectedURL
    }
    return nil
}

// –í load(from:):
if !FileManager.default.isReadableFile(atPath: datURL.path) {
    guard let accessibleURL = requestAccessToFile(datURL, description: "...") else {
        return .failure(...)
    }
    datURL = accessibleURL
}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù—É–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª
- ‚ùå –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ ENVI —Ñ–∞–π–ª–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ‚Üí –¥–∏–∞–ª–æ–≥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, –∑–∞—á–µ–º –≤—ã–±–∏—Ä–∞—Ç—å —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä—è–¥–æ–º

### –ü–æ—Å–ª–µ: –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

```swift
private static func requestAccessToDirectory(for fileURL: URL) -> Bool {
    let directory = fileURL.deletingLastPathComponent()
    
    var isGranted = false
    
    let showPanel = {
        let panel = NSOpenPanel()
        panel.message = "ENVI —Ñ–æ—Ä–º–∞—Ç —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø–∞—Ä–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏"
        panel.canChooseDirectories = true   // ‚úÖ –í—ã–±–∏—Ä–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        panel.canChooseFiles = false        // ‚úÖ –ù–µ –≤—ã–±–∏—Ä–∞–µ–º —Ñ–∞–π–ª—ã
        panel.directoryURL = directory      // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        
        if panel.runModal() == .OK, let selectedURL = panel.url {
            _ = selectedURL.startAccessingSecurityScopedResource()  // ‚úÖ –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø
            isGranted = true
        }
    }
    
    if Thread.isMainThread {
        showPanel()
    } else {
        DispatchQueue.main.sync(execute: showPanel)
    }
    
    return isGranted
}

// –í load(from:):
let hdrURL: URL
let datURL: URL

if fileExt == "hdr" {
    hdrURL = url
    datURL = findDataFile(basePath: basePath) ?? basePath.appendingPathExtension("dat")
} else {
    datURL = url
    hdrURL = basePath.appendingPathExtension("hdr")
}

// ‚úÖ –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ–±–æ–∏—Ö —Ñ–∞–π–ª–æ–≤
if !FileManager.default.isReadableFile(atPath: hdrURL.path) || 
   !FileManager.default.isReadableFile(atPath: datURL.path) {
    guard requestAccessToDirectory(for: url) else {
        return .failure(.readError("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å ENVI —Ñ–∞–π–ª–∞–º–∏"))
    }
}

// ‚úÖ –¢–µ–ø–µ—Ä—å –æ–±–∞ —Ñ–∞–π–ª–∞ –¥–æ—Å—Ç—É–ø–Ω—ã
guard FileManager.default.fileExists(atPath: hdrURL.path) else { ... }
guard FileManager.default.fileExists(atPath: datURL.path) else { ... }
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
- ‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã
- ‚úÖ –ü–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –ï—Å–ª–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ ENVI —Ñ–∞–π–ª–æ–≤ ‚Üí –¥–∏–∞–ª–æ–≥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π: –í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 3 ENVI —Ñ–∞–π–ª–∞

**–ë—ã–ª–æ (—Ñ–∞–π–ª–æ–≤—ã–π –¥–æ—Å—Ç—É–ø):**
```
1. –û—Ç–∫—Ä—ã–≤–∞–µ–º file1.hdr ‚Üí –¥–∏–∞–ª–æ–≥ –¥–ª—è file1.dat ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
2. –û—Ç–∫—Ä—ã–≤–∞–µ–º file2.hdr ‚Üí –¥–∏–∞–ª–æ–≥ –¥–ª—è file2.dat ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
3. –û—Ç–∫—Ä—ã–≤–∞–µ–º file3.hdr ‚Üí –¥–∏–∞–ª–æ–≥ –¥–ª—è file3.dat ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

–ò—Ç–æ–≥–æ: 3 –¥–∏–∞–ª–æ–≥–∞ ‚ùå
```

**–°—Ç–∞–ª–æ (–¥–∏—Ä–µ–∫—Ç–æ—Ä–Ω—ã–π –¥–æ—Å—Ç—É–ø):**
```
1. –û—Ç–∫—Ä—ã–≤–∞–µ–º file1.hdr ‚Üí –¥–∏–∞–ª–æ–≥ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
2. –û—Ç–∫—Ä—ã–≤–∞–µ–º file2.hdr ‚Üí –ø—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–¥–æ—Å—Ç—É–ø —É–∂–µ –µ—Å—Ç—å)
3. –û—Ç–∫—Ä—ã–≤–∞–µ–º file3.hdr ‚Üí –ø—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–¥–æ—Å—Ç—É–ø —É–∂–µ –µ—Å—Ç—å)

–ò—Ç–æ–≥–æ: 1 –¥–∏–∞–ª–æ–≥ ‚úÖ
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Security-Scoped Resource

```swift
_ = selectedURL.startAccessingSecurityScopedResource()
```

**–ß—Ç–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü–æ–ª—É—á–∞–µ—Ç **security-scoped bookmark** –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
- –î–æ—Å—Ç—É–ø —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è **–Ω–∞ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
- –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω—É–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å–Ω–æ–≤–∞
- –†–∞–±–æ—Ç–∞–µ—Ç **–≤ sandbox** (–Ω–µ –Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∞—Ç—å –∑–∞—â–∏—Ç—É)

**–ü–æ—á–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –¥–æ—Å—Ç—É–ø
- ‚úÖ –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
- ‚úÖ –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏
- ‚úÖ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: Persistent Bookmarks

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ—Å—Ç—É–ø **–º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏**:

```swift
// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å bookmark
if let bookmarkData = try? selectedURL.bookmarkData(
    options: .withSecurityScope,
    includingResourceValuesForKeys: nil,
    relativeTo: nil
) {
    UserDefaults.standard.set(bookmarkData, forKey: "enviDirectoryBookmark")
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø
if let bookmarkData = UserDefaults.standard.data(forKey: "enviDirectoryBookmark"),
   let url = try? URL(
       resolvingBookmarkData: bookmarkData,
       options: .withSecurityScope,
       relativeTo: nil,
       bookmarkDataIsStale: nil
   ) {
    _ = url.startAccessingSecurityScopedResource()
}
```

**–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**, –ø–æ—Ç–æ–º—É —á—Ç–æ:
- –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö entitlements
- –°–ª–æ–∂–Ω–µ–µ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –ù—É–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º bookmarks
- –ò–∑–±—ã—Ç–æ—á–Ω–æ –¥–ª—è –Ω–∞—à–µ–π –∑–∞–¥–∞—á–∏

## üéØ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

### –î–∏–∞–ª–æ–≥, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ENVI —Ñ–æ—Ä–º–∞—Ç —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏              ‚îÇ
‚îÇ —Å –ø–∞—Ä–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏                                    ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ üìÅ /Users/mac/test_data/                             ‚îÇ
‚îÇ    üìÑ pre_katrina05.hdr                              ‚îÇ
‚îÇ    üìÑ pre_katrina05.dat                              ‚îÇ
‚îÇ    üìÑ post_katrina05.hdr                             ‚îÇ
‚îÇ    üìÑ post_katrina05.dat                             ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ              [–û—Ç–º–µ–Ω–∞]  [–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü–æ–Ω—è—Ç–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:**
- ‚úÖ –ó–∞—á–µ–º –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø (–¥–ª—è –ø–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤)
- ‚úÖ –ö —á–µ–º—É –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è)
- ‚úÖ –ö–∞–∫–∏–µ —Ñ–∞–π–ª—ã —Ç–∞–º –Ω–∞—Ö–æ–¥—è—Ç—Å—è (–≤–∏–¥–Ω—ã –≤ –¥–∏–∞–ª–æ–≥–µ)

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –û–¥–∏–Ω–æ—á–Ω—ã–π —Ñ–∞–π–ª

```bash
# –í Finder: –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ pre_katrina05.hdr

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. –ü–æ—è–≤–∏—Ç—Å—è –¥–∏–∞–ª–æ–≥ "–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
2. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /test_data/ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞
3. –ö–ª–∏–∫ "–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø"
4. ‚úÖ –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
```

### –¢–µ—Å—Ç 2: –ù–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –≤ –æ–¥–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

```bash
# –í Finder: –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ pre_katrina05.hdr
# –î–∏–∞–ª–æ–≥ ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí –ó–∞–≥—Ä—É–∑–∫–∞ ‚úÖ

# –ó–∞–∫—Ä—ã—Ç—å —Ñ–∞–π–ª

# –í Finder: –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ post_katrina05.hdr
# –ó–∞–≥—Ä—É–∑–∫–∞ –ë–ï–ó –¥–∏–∞–ª–æ–≥–∞ ‚úÖ (–¥–æ—Å—Ç—É–ø —É–∂–µ –µ—Å—Ç—å)

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. –ü–µ—Ä–≤—ã–π —Ñ–∞–π–ª: –¥–∏–∞–ª–æ–≥ ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
2. –í—Ç–æ—Ä–æ–π —Ñ–∞–π–ª: –ø—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–¥–∏–∞–ª–æ–≥ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è)
```

### –¢–µ—Å—Ç 3: –§–∞–π–ª—ã –≤ —Ä–∞–∑–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö

```bash
# –í Finder: –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ /dir1/file1.hdr
# –î–∏–∞–ª–æ–≥ –¥–ª—è /dir1/ ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí –ó–∞–≥—Ä—É–∑–∫–∞ ‚úÖ

# –í Finder: –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ /dir2/file2.hdr
# –î–∏–∞–ª–æ–≥ –¥–ª—è /dir2/ ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí –ó–∞–≥—Ä—É–∑–∫–∞ ‚úÖ

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. –ö–∞–∂–¥–∞—è –Ω–æ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
2. –§–∞–π–ª—ã –≤ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±–µ–∑ –¥–∏–∞–ª–æ–≥–∞
```

### –¢–µ—Å—Ç 4: –û—Ç–∫–∞–∑ –≤ –¥–æ—Å—Ç—É–ø–µ

```bash
# –í Finder: –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ file.hdr
# –î–∏–∞–ª–æ–≥ ‚Üí "–û—Ç–º–µ–Ω–∞"

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
1. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å ENVI —Ñ–∞–π–ª–∞–º–∏"
2. –§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
3. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ ‚Üí –¥–∏–∞–ª–æ–≥ —Å–Ω–æ–≤–∞
```

## üìù –ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### EnviImageLoader.swift

```swift
class EnviImageLoader: ImageLoader {
    static let supportedExtensions = ["dat", "hdr", "img", "bsq", "bil", "bip", "raw"]
    
    // ‚úÖ –ù–û–í–´–ô –ú–ï–¢–û–î: –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    private static func requestAccessToDirectory(for fileURL: URL) -> Bool {
        let directory = fileURL.deletingLastPathComponent()
        
        var isGranted = false
        
        let showPanel = {
            let panel = NSOpenPanel()
            panel.message = "ENVI —Ñ–æ—Ä–º–∞—Ç —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø–∞—Ä–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏"
            panel.prompt = "–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø"
            panel.allowsMultipleSelection = false
            panel.canChooseDirectories = true   // –í—ã–±–æ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
            panel.canChooseFiles = false        // –ù–µ –≤—ã–±–∏—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
            panel.directoryURL = directory
            
            if panel.runModal() == .OK, let selectedURL = panel.url {
                _ = selectedURL.startAccessingSecurityScopedResource()
                isGranted = true
            }
        }
        
        if Thread.isMainThread {
            showPanel()
        } else {
            DispatchQueue.main.sync(execute: showPanel)
        }
        
        return isGranted
    }
    
    static func load(from url: URL) -> Result<HyperCube, ImageLoadError> {
        let fileExt = url.pathExtension.lowercased()
        let basePath = url.deletingPathExtension()
        
        let hdrURL: URL
        let datURL: URL
        
        if fileExt == "hdr" {
            hdrURL = url
            datURL = findDataFile(basePath: basePath) ?? basePath.appendingPathExtension("dat")
        } else {
            datURL = url
            hdrURL = basePath.appendingPathExtension("hdr")
        }
        
        // ‚úÖ –£–ü–†–û–©–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê: –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ–±–æ–∏—Ö —Ñ–∞–π–ª–æ–≤
        if !FileManager.default.isReadableFile(atPath: hdrURL.path) || 
           !FileManager.default.isReadableFile(atPath: datURL.path) {
            guard requestAccessToDirectory(for: url) else {
                return .failure(.readError("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å ENVI —Ñ–∞–π–ª–∞–º–∏"))
            }
        }
        
        guard FileManager.default.fileExists(atPath: hdrURL.path) else {
            return .failure(.readError("–ù–µ –Ω–∞–π–¥–µ–Ω .hdr —Ñ–∞–π–ª: \(hdrURL.lastPathComponent)"))
        }
        
        guard FileManager.default.fileExists(atPath: datURL.path) else {
            return .failure(.readError("–ù–µ –Ω–∞–π–¥–µ–Ω –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª. –û–∂–∏–¥–∞–µ—Ç—Å—è: \(datURL.lastPathComponent)"))
        }
        
        // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ...
    }
}
```

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ **–ü—Ä–æ—â–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: –æ–¥–∏–Ω –¥–∏–∞–ª–æ–≥ –≤–º–µ—Å—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö
- ‚úÖ **–ü–æ–Ω—è—Ç–Ω–µ–µ**: "–¥–æ—Å—Ç—É–ø –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏" –≤–º–µ—Å—Ç–æ "–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª"
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ**: –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è security-scoped resource
- ‚úÖ **–≠–ª–µ–≥–∞–Ω—Ç–Ω–µ–µ**: –º–µ–Ω—å—à–µ –∫–æ–¥–∞, –ø—Ä–æ—â–µ –ª–æ–≥–∏–∫–∞

## üìÖ –î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

2025-11-28

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `ENVI_SANDBOX_FIX.md` - –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ (—Ñ–∞–π–ª–æ–≤—ã–π –¥–æ—Å—Ç—É–ø)
- `EnviImageLoader.swift` - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- `ENVI_format.md` - —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞

