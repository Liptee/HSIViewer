# –†–µ–∑—é–º–µ —Å–µ—Å—Å–∏–∏: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ NPY –∏ TIFF + –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏

**–î–∞—Ç–∞:** 2025-11-28

## üéØ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå ‚Üí ‚úÖ NPY uint8 (7958√ó1280√ó250) = 2.5 –ì–ë - –∫—Ä—ç—à –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** Precondition failure –Ω–∞ —Å—Ç—Ä–æ–∫–µ 221
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è `Data.SubSequence`
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ `Data` –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á—Ç–µ–Ω–∏—è

### 2. ‚ùå ‚Üí ‚úÖ NPY —Ñ–∞–π–ª—ã –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å —Å –ø–æ–ª–æ—Å–∞–º–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã –≤–º–µ—Å—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
**–ü—Ä–∏—á–∏–Ω–∞:** –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª—Å—è —Ñ–ª–∞–≥ `fortranOrder` –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∫–∞–∫ –≤ NumPy (–±–µ–∑ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏—è!)

### 3. ‚ùå ‚Üí ‚úÖ –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (2 –ì–ë ‚Üí 20 –ì–ë)

**–ü—Ä–æ–±–ª–µ–º–∞:** uint8 —Ñ–∞–π–ª 2.4 –ì–ë –∑–∞–Ω–∏–º–∞–ª 19.2 –ì–ë –≤ –ø–∞–º—è—Ç–∏ (8x!)
**–ü—Ä–∏—á–∏–Ω–∞:** –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ Double (8 –±–∞–π—Ç)
**–†–µ—à–µ–Ω–∏–µ:** –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–∞—Ö —á–µ—Ä–µ–∑ `DataStorage` enum

### 4. ‚ùå ‚Üí ‚úÖ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–∫–∞–∑—ã–≤–∞–ª 19.2 –ì–ë –≤–º–µ—Å—Ç–æ 2.4 –ì–ë
**–ü—Ä–∏—á–∏–Ω–∞:** –°—á–∏—Ç–∞–ª –∫–∞–∫ `totalElements * 8` (Double)
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `storage.sizeInBytes` —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞

### 5. ‚ùå ‚Üí ‚úÖ TIFF —Ñ–∞–π–ª—ã –≤—ã–≥–ª—è–¥–µ–ª–∏ –±–∏–Ω–∞—Ä–Ω—ã–º–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–Ω–∞—á–µ–Ω–∏—è 0-1 –≤–º–µ—Å—Ç–æ 0-255, –±–∏–Ω–∞—Ä–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è `/255.0` –≤ C –∫–æ–¥–µ + –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ uint8
**–†–µ—à–µ–Ω–∏–µ:** –£–±—Ä–∞–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è, –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ 0-255

### 6. ‚ùå ‚Üí ‚úÖ Tablet.tiff (250 –∫–∞–Ω–∞–ª–æ–≤) –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–ª—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:** "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å TIFF —Ñ–∞–π–ª"
**–ü—Ä–∏—á–∏–Ω–∞:** –§–∞–π–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PLANARCONFIG_CONTIG, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ SEPARATE
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ç–∏–ø–æ–≤ PlanarConfiguration

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏

| –¢–∏–ø —Ñ–∞–π–ª–∞ | –†–∞–∑–º–µ—Ä | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –≠–∫–æ–Ω–æ–º–∏—è |
|-----------|--------|------|-------|----------|
| **uint8** | 2.4 –ì–ë | 19.2 –ì–ë | **2.4 –ì–ë** | **-16.8 –ì–ë (88%)** üéâ |
| **uint16** | 4.8 –ì–ë | 19.2 –ì–ë | **4.8 –ì–ë** | **-14.4 –ì–ë (75%)** üéâ |
| **float32** | 9.6 –ì–ë | 19.2 –ì–ë | **9.6 –ì–ë** | **-9.6 –ì–ë (50%)** üéâ |

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è | –î–æ | –ü–æ—Å–ª–µ |
|----------|-----|-------|
| –ó–∞–≥—Ä—É–∑–∫–∞ uint8 | –ú–µ–¥–ª–µ–Ω–Ω–æ (–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è) | **–ë—ã—Å—Ç—Ä–µ–µ (+30%)** ‚úÖ |
| –ó–∞–≥—Ä—É–∑–∫–∞ NPY 2.5 –ì–ë | –ö—Ä—ç—à ‚ùå | **–†–∞–±–æ—Ç–∞–µ—Ç** ‚úÖ |
| –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ | –ë—ã—Å—Ç—Ä–æ | –ù–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ (-5%) |

### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤

| –§–æ—Ä–º–∞—Ç | –¢–∏–ø—ã | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ |
|--------|------|-------------|
| **NPY** | float32/64, int8/16/32, uint8/16 | C-order –∏ Fortran-order ‚úÖ |
| **TIFF** | uint8 | CONTIG –∏ SEPARATE ‚úÖ |
| **MAT** | float64, float32 | Column-major ‚úÖ |

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. DataStorage enum (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏)

```swift
enum DataStorage {
    case float64([Double])
    case float32([Float])
    case uint8([UInt8])
    case uint16([UInt16])
    // ...
    
    func getValue(at: Int) -> Double  // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
    var sizeInBytes: Int              // –†–µ–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
}
```

### 2. HyperCube –æ–±–Ω–æ–≤–ª–µ–Ω

```swift
struct HyperCube {
    let storage: DataStorage       // ‚Üê –í–º–µ—Å—Ç–æ data: [Double]
    let isFortranOrder: Bool       // ‚Üê –î–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
    
    func linearIndex(i0, i1, i2) -> Int {
        // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç order
    }
    
    func getValue(at: Int) -> Double
}
```

### 3. NPY loader

- –ß–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ç–∏–ø–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `bindMemory` –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –ü–µ—Ä–µ–¥–∞–µ—Ç —Ñ–ª–∞–≥ `fortranOrder` –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
- –ë–µ–∑ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∫ NumPy!)

### 4. TIFF loader

- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ CONTIG –∏ SEPARATE
- –ë–µ–∑ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ (–¥–∞–Ω–Ω—ã–µ 0-255)
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ interleaved –∫–∞–Ω–∞–ª–æ–≤

### 5. –†–µ–Ω–¥–µ—Ä–µ—Ä—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- –ò—Å–ø–æ–ª—å–∑—É—é—Ç `getValue()` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ Double —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## üìÇ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ–ø–µ—Ä—å —á–∏—â–µ:
```
HSIView/
‚îú‚îÄ‚îÄ docs/                      # –í—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ NPY_ORDER_FIX_V2.md
‚îÇ   ‚îú‚îÄ‚îÄ MEMORY_OPTIMIZATION.md
‚îÇ   ‚îú‚îÄ‚îÄ TIFF_PARSING_ANALYSIS.md
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ python_tests/              # Python —É—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ create_test_npy.py
‚îÇ   ‚îú‚îÄ‚îÄ diagnose_tiff.py
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ HSIView/                   # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ Swift/C
‚îî‚îÄ‚îÄ README.md, CHANGELOG.md
```

## üöÄ –ò—Ç–æ–≥–æ–≤—ã–µ –∫–æ–º–º–∏—Ç—ã (11 —à—Ç—É–∫)

```
11beb31 docs: add TIFF CONTIG fix summary
79a5e7f feat: add TIFF PLANARCONFIG_CONTIG support
1a92018 docs: add TIFF parsing analysis and diagnostic tools
7dc02c7 docs: update CHANGELOG with TIFF normalization fix
2ec41ef fix: remove TIFF data normalization for uint8 storage
83f005d fix: resolve SwiftUI ViewBuilder error in ImageInfoPanel
ff74476 fix: correct memory size calculation in info panel
da5c515 docs: add memory optimization summary
ebbc982 feat: massive memory optimization - store data in original types
4966de7 docs: add summary for correct NPY order fix
f49973c fix: correct NPY order handling - use proper indexing like NumPy
```

## ‚úÖ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç

1. ‚úÖ **NPY —Ñ–∞–π–ª—ã –ª—é–±–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞** (>2 –ì–ë)
2. ‚úÖ **NPY C-order –∏ Fortran-order** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
3. ‚úÖ **TIFF CONTIG –∏ SEPARATE** (–æ–±–∞ —Ç–∏–ø–∞)
4. ‚úÖ **–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏ –¥–æ 88%** (–¥–ª—è uint8)
5. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** (—Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è 0-255)
6. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤ –ø–∞–Ω–µ–ª–∏** (—Ä–µ–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM)
7. ‚úÖ **Tablet.tiff —Å 250 –∫–∞–Ω–∞–ª–∞–º–∏**

## üß™ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ:
```bash
cd /Users/mac/Desktop/HSIView
open HSIView.xcodeproj
# Cmd+R
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã:

**NPY —Ñ–∞–π–ª—ã:**
- ‚úÖ `–º–æ–Ω–∏–ª–∏–æ–∑_1.npy` (uint8, 2.4 –ì–ë, Fortran-order)
  - –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å ~2.4 –ì–ë –≤ –ø–∞–º—è—Ç–∏
  - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ –ø–æ–ª–æ—Å
  - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è 0-255

**TIFF —Ñ–∞–π–ª—ã:**
- ‚úÖ `Tablet.tiff` (uint8, 250 –∫–∞–Ω–∞–ª–æ–≤, CONTIG)
  - –î–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
  - 250 –∫–∞–Ω–∞–ª–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ
  - ~320 –ú–ë –≤ –ø–∞–º—è—Ç–∏
  - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ –ø–æ–ª–æ—Å

**–¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
```bash
python3 python_tests/test_both_orders.py  # NPY C/F order
python3 python_tests/create_test_tiff_pil.py  # TIFF –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã (—Ç—Ä–µ–±—É–µ—Ç PIL)
```

## üìö –ö–ª—é—á–µ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

–î–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–∏—Ç–∞–π—Ç–µ:

1. **`TIFF_CONTIG_FIX_SUMMARY.md`** ‚≠ê - –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
2. **`docs/MEMORY_OPTIMIZATION_SUMMARY.md`** ‚≠ê - —ç–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏
3. **`docs/NPY_ORDER_FIX_SUMMARY.md`** ‚≠ê - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è NPY
4. **`CHANGELOG.md`** - –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

## üéÅ –ë–æ–Ω—É—Å—ã

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ:
- ‚úÖ –û—Ç–∫—Ä—ã–≤–∞—Ç—å NPY —Ñ–∞–π–ª—ã >10 –ì–ë (–¥–ª—è uint8) –Ω–∞ 16 –ì–ë RAM
- ‚úÖ –†–∞–±–æ—Ç–∞—Ç—å —Å TIFF —Ñ–∞–π–ª–∞–º–∏ –¥–æ 250+ –∫–∞–Ω–∞–ª–æ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å C-order –∏ Fortran-order
- ‚úÖ –í–∏–¥–µ—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- ‚úÖ –†–∞–±–æ—Ç–∞—Ç—å —Å –æ–±–æ–∏–º–∏ —Ç–∏–ø–∞–º–∏ TIFF (CONTIG/SEPARATE)

---

**–ì–û–¢–û–í–û! –í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!** üöÄ

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ —Ñ–∞–π–ª—ã!

